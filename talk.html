<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talk — Community Mural</title>

<!-- Fabric.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js"></script>
<!-- Firebase v8 (Realtime DB) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  /* ----------------- AESTHETIC (retro CRT / pixel vibe) ----------------- */
  :root{
    --bg:#030303; --panel:#0b0b0b; --muted:#9a9a9a; --accent:#dfeffb;
    --mono: "Roboto Mono", ui-monospace, monospace;
  }
  html,body{height:100%;margin:0;background:linear-gradient(#050507,#020203);color:#fff;font-family:var(--mono);-webkit-font-smoothing:antialiased;overflow:hidden;}
  /* subtle film grain overlay */
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:
      repeating-linear-gradient(0deg, rgba(255,255,255,0.006) 0 1px, transparent 1px 3px),
      radial-gradient(circle at 20% 20%, rgba(255,255,255,0.01), transparent 10%);
    mix-blend-mode:screen; opacity:0.08;
    z-index:1000;
  }
  /* scanlines */
  .scanlines{position:fixed; inset:0; pointer-events:none; z-index:999; opacity:0.06; background-image:linear-gradient(180deg, rgba(255,255,255,0.01) 0 1px, transparent 1px 3px); background-size:100% 3px;}
  /* subtle flicker */
  @keyframes flicker{0%{filter:brightness(1);}50%{filter:brightness(1.03);}100%{filter:brightness(0.98);}}
  .flicker{animation:flicker 2s ease-in-out infinite;}

  /* Intro overlay */
  .intro { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:2000; background:rgba(0,0,0,0.95); flex-direction:column; gap:18px; }
  .intro .panel{width:min(880px,92%); padding:28px; border-radius:10px; background:linear-gradient(#060606,#0a0a0a); border:1px solid rgba(255,255,255,0.04); box-shadow:0 30px 120px rgba(0,0,0,0.8);}
  .intro h1{font-size:1.5rem; margin:0; letter-spacing:0.18em; color:var(--accent); text-transform:uppercase;}
  .intro p{color:#cfcfcf;margin:10px 0 0;font-size:1rem;line-height:1.3}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.6rem .9rem;border-radius:6px;color:var(--accent);cursor:pointer;font-weight:700}
  .btn:active{transform:translateY(1px)}
  .subtle{color:var(--muted);font-size:.88rem}

  /* Main layout */
  #app{position:fixed; inset:0; display:flex; flex-direction:column; z-index:1;}
  header.topbar{height:62px; display:flex; align-items:center; gap:14px; padding:10px 18px; background:linear-gradient(#050505,#0b0b0b); border-bottom:1px solid rgba(255,255,255,0.03); z-index:50;}
  .brand{font-size:1.1rem;font-weight:900;letter-spacing:0.18em;color:var(--accent);text-transform:uppercase}
  .byline{opacity:.7;font-size:.85rem;margin-left:6px;color:var(--muted)}

  /* main stage */
  .stage{flex:1; position:relative; display:flex; gap:12px; padding:18px; align-items:stretch; justify-content:stretch;}
  .leftPanel{width:320px; background:linear-gradient(#060606,#0d0d0d); border:1px solid rgba(255,255,255,0.04); border-radius:10px; padding:12px; box-shadow:0 20px 60px rgba(0,0,0,0.6); overflow:auto}
  .canvasWrap{flex:1; position:relative; display:flex; align-items:center; justify-content:center; border-radius:10px; overflow:hidden}
  #mural{background:#050505; width:100%; height:100%; display:block; }

  .sectionTitle{font-weight:800;color:var(--accent);letter-spacing:0.12em;margin-bottom:8px}
  label.small{display:block;font-size:.78rem;color:var(--muted);margin-top:10px}

  /* toolbar rows */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .tool{padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:#fff;font-weight:700}
  .tool.active{outline:2px solid rgba(223,239,251,0.06); box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  input[type=color]{width:44px;height:36px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);padding:0;background:#000}
  input[type=range]{width:120px}

  /* stamps row */
  .stamps{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .stampBtn{width:48px;height:48px;border-radius:6px;background:#070707;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px}

  /* message form */
  .messageForm{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .messageForm input, .messageForm textarea{background:#050505;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;color:#fff;font-family:var(--mono)}
  .messageForm .row{display:flex;gap:8px}

  /* floating messages container */
  #floating{position:absolute; inset:10px; pointer-events:none; z-index:30}
  .bubble{
    position:absolute; pointer-events:auto; padding:8px 10px; background:linear-gradient(#080808,#0c0c0c);
    border:1px solid rgba(255,255,255,0.04); border-radius:10px; color:#fff; max-width:240px;
    box-shadow:0 18px 60px rgba(0,0,0,0.6); touch-action:none; cursor:grab; user-select:none;
  }
  .bubble .meta{font-size:11px;color:var(--muted);margin-top:8px;display:flex;justify-content:space-between}
  .bubble .adminDelete{display:none}
  .adminMode .bubble .adminDelete{display:inline-block}

  /* admin gear */
  #adminGear{position:fixed; right:14px; top:14px; z-index:60; width:40px; height:40px; border-radius:8px; background:#070707; border:1px solid rgba(255,255,255,0.04); display:flex;align-items:center;justify-content:center; cursor:pointer}
  #adminGear:hover{transform:translateY(-2px)}

  /* responsive */
  @media (max-width:880px){
    .stage{flex-direction:column}
    .leftPanel{width:100%;order:2}
    .canvasWrap{order:1;height:60vh}
  }

  /* pixel-ish text for headings */
  @font-face{font-family:PixelLike; src: local("Courier New");}
  .pixel{font-family:PixelLike, var(--mono)}
</style>
</head>
<body>
  <!-- scanlines -->
  <div class="scanlines" aria-hidden="true"></div>

  <!-- Intro overlay -->
  <div id="intro" class="intro" role="dialog" aria-label="Welcome overlay">
    <div class="panel flicker">
      <h1 id="introTitle">PLACEHOLDER WELCOME MESSAGE</h1>
      <p id="introBody" class="subtle">This is a placeholder — write whatever you like. A subtle glitch animation and grain set the mood.</p>

      <div style="display:flex;gap:10px;align-items:center;margin-top:18px;justify-content:center">
        <button id="agreeBtn" class="btn">Sure thing</button>
        <button id="peekBtn" class="btn" title="Peek">Peek (no drawing)</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" aria-hidden="true">
    <header class="topbar">
      <div class="brand">S Y N T</div>
      <div class="byline">talk — collaborative mural</div>
    </header>

    <div class="stage">
      <aside class="leftPanel">
        <div class="sectionTitle">Tools</div>
        <div class="toolbar" id="toolsRow">
          <button class="tool active" data-tool="pen">Pen</button>
          <button class="tool" data-tool="marker">Marker</button>
          <button class="tool" data-tool="pixel">Pixel</button>
          <button class="tool" data-tool="spray">Spray</button>
          <button class="tool" data-tool="shape">Shape</button>
          <button class="tool" data-tool="eraser">Eraser</button>
        </div>

        <label class="small">Size</label>
        <input id="size" type="range" min="1" max="64" value="6">

        <label class="small">Color</label>
        <input id="color" type="color" value="#ffffff">

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="undo" class="tool">Undo</button>
          <button id="clearLocal" class="tool">Clear</button>
          <button id="saveBtn" class="tool">Save</button>
        </div>

        <div class="sectionTitle" style="margin-top:14px">Stamps</div>
        <div class="stamps" id="stampsRow" aria-hidden="false"></div>

        <div class="sectionTitle" style="margin-top:12px">Post a message</div>
        <form id="messageForm" class="messageForm" onsubmit="return false;">
          <input id="name" placeholder="Your name (optional)" maxlength="60">
          <textarea id="message" rows="3" placeholder="Write a short message (it will float)" maxlength="300"></textarea>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="postMsg" class="btn">Post to wall</button>
            <div class="subtle" style="margin-left:auto" id="msgHint">Messages float & bounce</div>
          </div>
        </form>

        <div style="height:18px"></div>
        <div class="subtle">Tip: Use stamps, then post a message. Admin can delete.</div>
      </aside>

      <div class="canvasWrap" aria-live="polite">
        <canvas id="mural"></canvas>
        <div id="floating"></div>
      </div>
    </div>
  </div>

  <!-- admin gear -->
  <div id="adminGear" title="Admin" aria-hidden="false">⚙️</div>

<script>
/* =======================
   talk.html — Phase 1 mural
   - Uses Fabric.js for drawing
   - Saves canvas JSON to Firebase Realtime DB under /canvasState
   - Saves messages to /messages
   - Floating bubbles with simple bounce physics
   - Admin password (indobingo) toggles admin controls
   ======================= */

(function(){
  // ---------- Firebase config (from your original site) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBeXCRIeRdHr2C3EYnDwC1NoQNQxZygA0U",
    authDomain: "guestbook-bfbdc.firebaseapp.com",
    databaseURL: "https://guestbook-bfbdc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "guestbook-bfbdc",
    storageBucket: "guestbook-bfbdc.firebasestorage.app",
    messagingSenderId: "710789947600",
    appId: "1:710789947600:web:19014ef99d053f4c5dbed5",
    measurementId: "G-E9XPN9563X"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- DOM ----------
  const intro = document.getElementById('intro');
  const agreeBtn = document.getElementById('agreeBtn');
  const peekBtn = document.getElementById('peekBtn');
  const app = document.getElementById('app');
  const muralEl = document.getElementById('mural');
  const floating = document.getElementById('floating');
  const toolsRow = document.getElementById('toolsRow');
  const stampsRow = document.getElementById('stampsRow');
  const colorEl = document.getElementById('color');
  const sizeEl = document.getElementById('size');
  const undoBtn = document.getElementById('undo');
  const clearLocalBtn = document.getElementById('clearLocal');
  const saveBtn = document.getElementById('saveBtn');
  const postMsgBtn = document.getElementById('postMsg');
  const nameEl = document.getElementById('name');
  const messageEl = document.getElementById('message');
  const adminGear = document.getElementById('adminGear');

  // ---------- state ----------
  let adminMode = false;
  const ADMIN_PASSWORD = 'indobingo'; // change if you want
  let myName = sessionStorage.getItem('mural_name') || ('anon-'+Math.floor(Math.random()*9000));
  nameEl.value = myName;

  // ---------- init Fabric canvas ----------
  const fabricCanvas = new fabric.Canvas('mural', {
    backgroundColor: '#050505',
    isDrawingMode: true,
    selection: false,
    renderOnAddRemove: true
  });

  // resize canvas to container
  function fitCanvas(){
    const rect = muralEl.parentElement.getBoundingClientRect();
    muralEl.width = Math.max(300, Math.floor(rect.width));
    muralEl.height = Math.max(300, Math.floor(rect.height));
    fabricCanvas.setWidth(muralEl.width);
    fabricCanvas.setHeight(muralEl.height);
    fabricCanvas.renderAll();
  }
  window.addEventListener('resize', fitCanvas, {passive:true});
  setTimeout(fitCanvas, 60);

  // ---------- tool controls ----------
  let currentTool = 'pen';
  function setTool(tool){
    currentTool = tool;
    Array.from(toolsRow.querySelectorAll('.tool')).forEach(t => t.classList.toggle('active', t.dataset.tool===tool));
    fabricCanvas.isDrawingMode = (tool !== 'shape' && tool !== 'eraser');
    if(tool==='eraser'){ // emulate eraser by setting globalCompositeOperation when drawing; simpler: use fabric.EraserBrush if available
      fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(fabricCanvas);
      fabricCanvas.freeDrawingBrush.width = parseInt(sizeEl.value,10) || 6;
      fabricCanvas.freeDrawingBrush.color = '#000000';
    } else if(tool==='marker'){
      const b = new fabric.PencilBrush(fabricCanvas);
      b.width = parseInt(sizeEl.value,10) * 1.8;
      b.color = colorEl.value;
      b.decimate = 0.4;
      fabricCanvas.freeDrawingBrush = b;
    } else if(tool==='pixel'){
      const b = new fabric.PencilBrush(fabricCanvas);
      b.width = Math.max(1, Math.round(sizeEl.value/1.6));
      b.color = colorEl.value;
      fabricCanvas.freeDrawingBrush = b;
    } else if(tool==='spray'){
      // simple spray approximation using randomized short strokes in pointer events
      const b = new fabric.PencilBrush(fabricCanvas);
      b.width = Math.max(1, Math.round(sizeEl.value/1.6));
      b.color = colorEl.value;
      fabricCanvas.freeDrawingBrush = b;
    } else { // pen/fallback
      const b = new fabric.PencilBrush(fabricCanvas);
      b.width = parseInt(sizeEl.value,10) || 6;
      b.color = colorEl.value;
      fabricCanvas.freeDrawingBrush = b;
    }
  }
  toolsRow.addEventListener('click', (e) => {
    const btn = e.target.closest('.tool');
    if(!btn) return;
    setTool(btn.dataset.tool);
  });
  setTool('pen');

  colorEl.addEventListener('input', ()=> setTool(currentTool));
  sizeEl.addEventListener('input', ()=> setTool(currentTool));

  // undo (fabric history simple)
  undoBtn.addEventListener('click', ()=> {
    const objs = fabricCanvas.getObjects();
    if(objs.length) {
      fabricCanvas.remove(objs[objs.length-1]);
      fabricCanvas.renderAll();
    }
  });

  clearLocalBtn.addEventListener('click', ()=> {
    if(!confirm('Clear local canvas? This does not delete server copy.')) return;
    fabricCanvas.clear();
    fabricCanvas.backgroundColor = '#050505';
    fabricCanvas.renderAll();
  });

  saveBtn.addEventListener('click', saveCanvasToFirebase);

  // ---------- stamps definitions (inline SVG converted to fabric objects) ----------
  const STAMPS = [
    { id:'cat1', label:'Cat', svg: `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#0b0b0b'/><g transform='scale(1.5) translate(6,6)'><rect x='2' y='18' width='40' height='16' fill='#fff'/><rect x='8' y='8' width='4' height='6' fill='#fff'/><rect x='30' y='8' width='4' height='6' fill='#fff'/><rect x='8' y='18' width='8' height='8' fill='#ffdede'/><rect x='24' y='18' width='8' height='8' fill='#ffdede'/></g></svg>` },
    { id:'cat2', label:'Kitty', svg: `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#0a0a0a'/><g transform='scale(1.2) translate(8,6)'><path d='M10 30 q10 -20 30 0 q-5 20 -30 0' fill='#fff'/><circle cx='16' cy='24' r='3' fill='#000'/><circle cx='28' cy='24' r='3' fill='#000'/></g></svg>`},
    { id:'star', label:'Star', svg:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#050505'/><polygon points='32,6 38,26 60,26 42,38 48,58 32,46 16,58 22,38 4,26 26,26' fill='#ffd36d'/></svg>`},
    { id:'skull', label:'Skull', svg:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#060606'/><g transform='translate(8,8)'><rect x='8' y='8' width='16' height='18' rx='6' fill='#fff'/><rect x='28' y='12' width='8' height='8' fill='#fff'/></g></svg>`},
    { id:'heart', label:'Heart', svg:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#040404'/><path d='M32 50 L12 30 A8 8 0 0 1 32 14 A8 8 0 0 1 52 30 Z' fill='#ff7aa2'/></svg>`},
    { id:'floppy', label:'Floppy', svg:`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='#040404'/><rect x='10' y='8' width='36' height='36' fill='#cfeffb' rx='3'/><rect x='16' y='16' width='24' height='16' fill='#0b0b0b'/></svg>`}
  ];

  function makeStampButton(s){
    const btn = document.createElement('button');
    btn.className='stampBtn';
    btn.title = s.label;
    btn.innerHTML = s.svg;
    btn.addEventListener('click', ()=> {
      // add as fabric.Image from SVG
      fabric.loadSVGFromString(s.svg, (objects, options) => {
        const obj = fabric.util.groupSVGElements(objects, options);
        obj.set({ left: fabricCanvas.getWidth()/2 - 40 + (Math.random()*80-40), top: fabricCanvas.getHeight()/2 - 40 + (Math.random()*80-40), scaleX:1.2, scaleY:1.2, selectable:true });
        fabricCanvas.add(obj);
        fabricCanvas.renderAll();
      });
    });
    return btn;
  }
  STAMPS.forEach(s => stampsRow.appendChild(makeStampButton(s)));

  // ---------- save & load canvas ----------
  function saveCanvasToFirebase(){
    try{
      const json = fabricCanvas.toJSON(['selectable']);
      db.ref('canvasState').set(json).then(()=> {
        saveBtn.textContent = 'Saved ✓';
        setTimeout(()=> saveBtn.textContent = 'Save', 1200);
      }).catch(err => { console.error('save err',err); alert('Save failed'); });
    }catch(e){ console.error(e); alert('Save failed'); }
  }

  function loadCanvasFromFirebase(){
    db.ref('canvasState').once('value').then(snap => {
      const data = snap.val();
      if(!data) return;
      try{
        fabricCanvas.clear();
        fabricCanvas.loadFromJSON(data, fabricCanvas.renderAll.bind(fabricCanvas), function(o, object){
          // optional: post-processing
        });
      }catch(e){ console.error('load err', e); }
    }).catch(err => console.error('load canvas err',err));
  }
  // initial load
  loadCanvasFromFirebase();

  // listen to server updates (if another session saves later)
  db.ref('canvasState').on('value', snap=>{
    const data = snap.val();
    if(!data) return;
    try{
      // only update if the canvas is empty or user asked to load
      if(fabricCanvas.getObjects().length < 1){
        fabricCanvas.clear(); fabricCanvas.loadFromJSON(data, fabricCanvas.renderAll.bind(fabricCanvas));
      }
    }catch(e){ console.error(e); }
  });

  // ---------- messages (floating bubbles) ----------
  const bubbles = {}; // id -> state
  function createBubble(id, data){
    const el = document.createElement('div');
    el.className = 'bubble';
    el.innerHTML = `<div class="text">${escapeHtml(data.text)}</div><div class="meta"><div>${escapeHtml(data.name || 'anon')}</div><div class="controls"><button class="tool react">❤</button> <button class="tool adminDelete">Del</button></div></div>`;
    floating.appendChild(el);
    // initial position
    el.style.left = (data.x || (50 + Math.random()*(fabricCanvas.getWidth()-200))) + 'px';
    el.style.top = (data.y || (50 + Math.random()*(fabricCanvas.getHeight()-200))) + 'px';
    const rect = el.getBoundingClientRect();
    const state = { id, el, x: parseFloat(el.style.left), y: parseFloat(el.style.top), vx:(Math.random()*2-1)*0.8, vy:(Math.random()*2-1)*0.8, w: rect.width, h:rect.height };
    bubbles[id] = state;

    // drag to move
    let drag=false, ox=0, oy=0;
    el.addEventListener('pointerdown', (ev)=>{
      drag=true; ox = ev.clientX - state.x; oy = ev.clientY - state.y; el.style.cursor='grabbing';
      el.setPointerCapture && el.setPointerCapture(ev.pointerId);
    });
    window.addEventListener('pointermove',(ev)=>{ if(!drag) return; state.x = ev.clientX - ox; state.y = ev.clientY - oy; el.style.left = state.x+'px'; el.style.top = state.y+'px'; });
    window.addEventListener('pointerup',()=>{ if(drag){ drag=false; el.style.cursor='grab'; /* persist pos */ db.ref('messages/'+id+'/x').set(state.x); db.ref('messages/'+id+'/y').set(state.y); } });

    // admin delete
    el.querySelector('.adminDelete').addEventListener('click', ()=> {
      if(!adminMode) return;
      if(!confirm('Delete message?')) return;
      db.ref('messages/'+id).remove();
      // local removal handled in child_removed listener
    });

    // reaction (just increments heart count)
    el.querySelector('.react').addEventListener('click', ()=> {
      db.ref('messages/'+id+'/reactions/heart').transaction(v => (v||0)+1);
    });
  }

  // listen messages realtime
  db.ref('messages').on('child_added', snap=>{
    const id = snap.key; const d = snap.val();
    if(!d) return;
    // create bubble if not exists
    if(!bubbles[id]) createBubble(id, d);
  });
  db.ref('messages').on('child_changed', snap=>{
    const id = snap.key; const d = snap.val();
    const b = bubbles[id];
    if(!b) return;
    const textEl = b.el.querySelector('.text');
    if(textEl) textEl.textContent = d.text || '';
    const nameElLocal = b.el.querySelector('.meta > div');
    if(nameElLocal) nameElLocal.textContent = d.name || 'anon';
    const reactionEl = b.el.querySelector('.react');
    // optional reaction display logic
  });
  db.ref('messages').on('child_removed', snap=>{
    const id = snap.key;
    const b = bubbles[id];
    if(b){ b.el.remove(); delete bubbles[id]; }
  });

  // post message
  postMsgBtn.addEventListener('click', ()=>{
    const name = (nameEl.value||'').trim() || nameEl.value || 'anon';
    const text = (messageEl.value||'').trim();
    if(!text){ alert('Please write something'); return; }
    const payload = { name, text, t: Date.now(), x: Math.random()*(fabricCanvas.getWidth()-220)+30, y: Math.random()*(fabricCanvas.getHeight()-140)+30, reactions:{heart:0} };
    db.ref('messages').push(payload).then(()=> {
      messageEl.value = '';
    }).catch(err=> console.error(err));
  });

  // simple bubble physics loop
  function physicsTick(){
    const keys = Object.keys(bubbles);
    for(const k of keys){
      const s = bubbles[k];
      // only update if not being dragged
      s.x += s.vx; s.y += s.vy;
      // bounce edges
      const cw = fabricCanvas.getWidth(), ch=fabricCanvas.getHeight();
      if(s.x < 6){ s.x = 6; s.vx *= -1; }
      if(s.y < 6){ s.y = 6; s.vy *= -1; }
      if(s.x + s.w > cw - 6){ s.x = cw - s.w - 6; s.vx *= -1; }
      if(s.y + s.h > ch - 6){ s.y = ch - s.h - 6; s.vy *= -1; }
      s.el.style.left = s.x+'px'; s.el.style.top = s.y+'px';
    }
    requestAnimationFrame(physicsTick);
  }
  physicsTick();

  // ---------- admin ----------
  adminGear.addEventListener('click', ()=>{
    if(adminMode){
      adminMode = false; document.body.classList.remove('adminMode'); sessionStorage.removeItem('mural_admin');
      alert('Admin off');
      return;
    }
    const p = prompt('Enter admin password:');
    if(p === ADMIN_PASSWORD){
      adminMode = true;
      document.body.classList.add('adminMode');
      sessionStorage.setItem('mural_admin','1');
      alert('Admin enabled. You can now delete messages or clear mural.');
      // add clear mural control
      if(!document.getElementById('adminClear')){
        const btn = document.createElement('button'); btn.className='tool'; btn.id='adminClear'; btn.textContent='Clear mural';
        btn.addEventListener('click', ()=> {
          if(!confirm('Clear entire mural for everyone? This deletes saved canvas and messages.')) return;
          db.ref('canvasState').remove();
          db.ref('messages').remove();
          fabricCanvas.clear(); fabricCanvas.backgroundColor = '#050505'; fabricCanvas.renderAll();
          // remove bubbles
          Object.keys(bubbles).forEach(id => { if(bubbles[id]) bubbles[id].el.remove(); delete bubbles[id]; });
        });
        document.querySelector('.leftPanel .toolbar').appendChild(btn);
      }
    } else {
      alert('Wrong password');
    }
  });

  // rehydrate admin mode if saved
  if(sessionStorage.getItem('mural_admin') === '1'){
    adminMode = true; document.body.classList.add('adminMode');
  }

  // ---------- intro behavior ----------
  function enterFull(allowDraw){
    // remove intro, reveal app and enable drawing (and optionally disable drawing if peek)
    intro.style.display = 'none';
    app.setAttribute('aria-hidden','false');
    if(!allowDraw) fabricCanvas.isDrawingMode = false;
    else fabricCanvas.isDrawingMode = (currentTool !== 'eraser' && currentTool !== 'shape');
    fitCanvas();
  }
  agreeBtn.addEventListener('click', ()=> enterFull(true));
  peekBtn.addEventListener('click', ()=> enterFull(false));

  // small tasteful glitch animation for intro text (characters appear)
  (function glitchIntro(){
    const title = document.getElementById('introTitle');
    const full = title.textContent;
    title.textContent = '';
    let i=0;
    function step(){
      if(i>full.length) return;
      title.textContent = full.slice(0,i) + (i%2 ? '▮' : '');
      i++;
      setTimeout(step, 30 + Math.random()*80);
    }
    step();
  })();

  // ---------- helpers ----------
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ---------- small autosave to server on idle ----------
  let saveTimer = null;
  function scheduleSave(){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveCanvasToFirebase, 2500);
  }
  fabricCanvas.on('path:created', scheduleSave);
  fabricCanvas.on('object:added', scheduleSave);
  fabricCanvas.on('object:modified', scheduleSave);

  // ---------- helper: load initial demo if empty (so it's not a black screen) ----------
  db.ref('canvasState').once('value').then(snap=>{
    if(!snap.exists()){
      // draw demo strokes locally (not saved unless saved)
      const p = new fabric.PencilBrush(fabricCanvas);
      p.width = 6; p.color = '#9fe4ff';
      // small demo line (drawn programmatically)
      const points = [{x:80,y:120},{x:120,y:160},{x:200,y:120}];
      const path = new fabric.Path(`M ${points.map(pt=>pt.x+','+pt.y).join(' L ')}`, { stroke:'#9fe4ff', strokeWidth:6, fill:'' });
      fabricCanvas.add(path);
      fabricCanvas.renderAll();
    }
  });

  // ensure name persists
  nameEl.addEventListener('change', ()=> sessionStorage.setItem('mural_name', nameEl.value||myName));

  // END IIFE
})();
</script>
</body>
</html>
