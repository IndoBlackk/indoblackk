<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>synt — Mural (Rebuild: Brush, Color, Stamps)</title>
    <style>
        :root {
            --bg: #000;
            --fg: #fff;
            --accent: #fff;
            --toolbar-w: 96px;
            --pixel-font: "Lucida Console", Monaco, monospace
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: var(--pixel-font);
            -webkit-font-smoothing: antialiased;
            overflow: hidden
        }

        .scanline {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: linear-gradient(180deg, rgba(255, 255, 255, 0.02) 0 1px, transparent 1px 3px);
            opacity: 0.06;
            mix-blend-mode: overlay;
            z-index: 5
        }

        /* Intro */
        #intro {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 200
        }

        .boot-text {
            font-size: 20px;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            margin-bottom: 12px
        }

        .loading-box {
            width: 360px;
            height: 44px;
            border: 4px solid #fff;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative
        }

        .loading-steps {
            position: absolute;
            left: 6px;
            right: 6px;
            top: 6px;
            bottom: 6px;
            display: flex;
            gap: 6px
        }

        .loading-step {
            flex: 1;
            background: #000;
            border: 2px solid #fff;
            min-width: 8px
        }

        /* sure button and blinker */
        #sureBtn {
            display: none;
            margin-top: 12px;
            padding: 8px 14px;
            border: 3px solid #fff;
            background: #fff;
            color: #000;
            cursor: pointer;
            font-weight: 700
        }

        #blinker {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.9
        }

        /* Left toolbar */
        .toolbar {
            position: fixed;
            left: 12px;
            top: 12px;
            width: var(--toolbar-w);
            bottom: 12px;
            background: #000;
            border: 4px solid #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            gap: 8px;
            z-index: 60
        }

        .logo-small {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 6px
        }

        .tool-btn {
            width: 76px;
            height: 42px;
            background: #fff;
            color: #000;
            border: 3px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
            user-select: none
        }

        .tool-btn:hover {
            background: #000;
            color: #fff
        }

        .icon {
            font-size: 18px;
            line-height: 1
        }

        /* Mural area */
        #mural {
            position: fixed;
            left: calc(var(--toolbar-w) + 36px);
            right: 12px;
            top: 12px;
            bottom: 12px;
            background: #000;
            border: 4px solid #fff;
            overflow: hidden;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .mural-canvas {
            position: relative;
            width: 100%;
            height: 100%
        }

        /* popup windows */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 210
        }

        .window {
            background: #f8f8f8;
            color: #000;
            border: 4px solid #000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            width: min(920px, 94%);
            max-width: 920px;
            border-radius: 2px
        }

        .titlebar {
            background: #000;
            color: #fff;
            padding: 6px 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700
        }

        .title-left {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .drag-handle {
            width: 44px;
            height: 8px;
            background: repeating-linear-gradient(90deg, #fff 0 2px, #000 2px 4px);
            border: 2px solid #000
        }

        .title-close {
            background: #fff;
            color: #000;
            padding: 2px 6px;
            border: 2px solid #000;
            cursor: pointer
        }

        /* doodle content */
        .doodle-body {
            display: flex;
            gap: 12px;
            padding: 12px
        }

        .canvas-wrap {
            background: #fff;
            padding: 6px;
            border: 4px solid #000
        }

        #doodleCanvas {
            background: #fff;
            display: block;
            width: 820px;
            height: 520px
        }

        .tools-col {
            min-width: 160px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .tool-small {
            height: 36px;
            background: #fff;
            border: 3px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700
        }

        .tool-small:hover {
            background: #000;
            color: #fff
        }

        .swatches {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 6px
        }

        .swatch {
            width: 28px;
            height: 20px;
            border: 2px solid #000;
            cursor: pointer
        }

        /* stamp picker window */
        .stamp-window {
            width: 360px;
            max-width: 92%;
            background: #f8f8f8;
            border: 4px solid #000
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(5, 64px);
            gap: 8px;
            padding: 8px
        }

        .stamp-tile {
            width: 64px;
            height: 64px;
            border: 3px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            cursor: pointer
        }

        /* note modal */
        .note-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .input,
        textarea {
            background: #000;
            color: #fff;
            border: 3px solid #fff;
            padding: 8px
        }

        /* side panel */
        #sidePanel {
            position: fixed;
            right: 12px;
            top: 12px;
            width: 320px;
            bottom: 12px;
            background: #000;
            border: 4px solid #fff;
            padding: 12px;
            z-index: 70;
            overflow: auto;
            display: none
        }

        .side-close {
            float: right;
            cursor: pointer;
            border: 2px solid #fff;
            padding: 2px 6px;
            background: #fff;
            color: #000;
            font-weight: 700
        }

        /* mural item */
        .mural-item {
            position: absolute;
            cursor: grab;
            border: 2px solid #fff;
            background: #fff;
            padding: 4px
        }

        .mural-item img {
            display: block;
            max-width: 320px;
            max-height: 240px
        }

        .note-box {
            background: #fff;
            color: #000;
            padding: 8px;
            border: 2px solid #000;
            max-width: 280px;
            white-space: pre-wrap
        }

        /* responsive */
        @media (max-width:920px) {
            #doodleCanvas {
                width: 600px;
                height: 380px
            }

            .canvas-wrap {
                padding: 4px
            }
        }
    </style>
</head>

<body>
    <div class="scanline"></div>

    <!-- Intro -->
    <div id="intro" aria-hidden="false">
        <div style="text-align:center">
            <div class="boot-text">LOADING MURAL OS...</div>
            <div class="loading-box">
                <div class="loading-steps" id="loadingSteps"></div>
            </div>
            <button id="sureBtn">SURE THING</button>
            <div id="blinker" style="display:none">PRESS ANY KEY TO CONTINUE</div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar" aria-hidden="false">
        <div class="logo-small">MURAL OS</div>
        <div class="tool-btn" id="btnDoodle" title="Make a doodle">
            <div class="icon">✎</div>
            <div style="font-size:11px">DOODLE</div>
        </div>
        <div class="tool-btn" id="btnNote" title="Leave a note">
            <div class="icon">✉</div>
            <div style="font-size:11px">NOTE</div>
        </div>
        <div style="flex:1"></div>
        <div class="tool-btn" id="btnAdmin">
            <div class="icon">⚙</div>
            <div style="font-size:11px">ADMIN</div>
        </div>
    </div>

    <!-- Mural -->
    <div id="mural">
        <div class="mural-canvas" id="muralCanvas"></div>
    </div>

    <!-- Side panel -->
    <div id="sidePanel" aria-hidden="true">
        <div><strong id="sideTitle">Item</strong> <button class="side-close" id="sideClose">CLOSE</button></div>
        <div id="sideContent"></div>
        <div style="margin-top:8px">
            <div id="adminControls" style="display:none">
                <button id="deleteItem">Delete</button>
                <button id="clearMural">Clear</button>
            </div>
        </div>
    </div>

    <!-- Doodle modal -->
    <div class="modal-backdrop" id="doodleModal">
        <div class="window" role="dialog" aria-modal="true" aria-label="Doodle">
            <div class="titlebar">
                <div class="title-left">
                    <div class="drag-handle" aria-hidden="true"></div>
                    <div style="margin-left:8px">CREATE A DOODLE</div>
                </div>
                <div class="title-close" id="doodleClose">X</div>
            </div>
            <div class="doodle-body">
                <div class="canvas-wrap">
                    <canvas id="doodleCanvas" width="820" height="520"></canvas>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button class="tool-small" id="submitDoodle" type="button">SUBMIT</button>
                        <button class="tool-small" id="cancelDoodle" type="button">CANCEL</button>
                    </div>
                </div>
                <div class="tools-col">
                    <div style="font-weight:700">TOOLS</div>
                    <button class="tool-small" id="toolBrush" type="button">Brush</button>
                    <button class="tool-small" id="toolEraser" type="button">Eraser</button>
                    <button class="tool-small" id="toolStampWindow" type="button">Stamps</button>
                    <button class="tool-small" id="toolUndo" type="button">Undo</button>
                    <button class="tool-small" id="toolClear" type="button">Clear</button>
                    <div style="font-weight:700">Brush size</div>
                    <input type="range" id="brushSize" min="1" max="48" value="4" />
                    <div style="font-weight:700">Color</div>
                    <input type="color" id="colorPicker" value="#000000" style="width:100%;height:36px;border:3px solid #000;background:#fff" />
                </div>
            </div>
        </div>
    </div>

    <!-- Stamp picker window (separate retro window centered) -->
    <div class="modal-backdrop" id="stampModal">
        <div class="stamp-window window" role="dialog" aria-modal="true" aria-label="Stamp picker">
            <div class="titlebar">
                <div class="title-left">
                    <div class="drag-handle"></div>
                    <div style="margin-left:8px">CHOOSE A STAMP</div>
                </div>
                <div class="title-close" id="stampClose">X</div>
            </div>
            <div style="padding:8px">
                <div class="stamp-grid" id="stampGrid"></div>
            </div>
        </div>
    </div>

    <!-- Note modal -->
    <div class="modal-backdrop" id="noteModal">
        <div class="window" role="dialog" aria-modal="true" aria-label="Leave a note">
            <div class="titlebar">
                <div class="title-left">
                    <div class="drag-handle"></div>
                    <div style="margin-left:8px">LEAVE A NOTE</div>
                </div>
                <div class="title-close" id="noteClose">X</div>
            </div>
            <div class="note-body">
                <input id="noteName" class="input" placeholder="Your name (optional)" />
                <textarea id="noteText" class="input" rows="4" placeholder="Write a note..."></textarea>
                <div style="display:flex;gap:8px">
                    <button class="tool-small" id="submitNote" type="button">SUBMIT</button>
                    <button class="tool-small" id="cancelNote" type="button">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio placeholders (tiny base64) -->
    <audio id="sndClick">
        <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
    </audio>
    <audio id="sndPlace">
        <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
    </audio>
    <audio id="sndBleep">
        <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
    </audio>

    <script type="module">
        /* Rebuild: Fabric-based doodle with color picker and curated pixel stamps.
           Fixes applied: robust ready() handling, normalized button types,
           accessible tool divs, rebind inline onclicks, reliable event wiring.
        */

        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            doc,
            updateDoc,
            deleteDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ---------- small helpers ----------
        function log(...args) {
            if (window.console && console.log) console.log('[mural-fix]', ...args);
        }

        // ready helper: runs fn immediately if DOM already ready, otherwise on DOMContentLoaded
        function ready(fn) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', fn, { once: true });
            } else {
                // DOM already ready
                setTimeout(fn, 0);
            }
        }

        // ensure any <button> without type defaults to type="button"
        function normalizeButtonTypes() {
            document.querySelectorAll('button').forEach(b => {
                if (!b.hasAttribute('type')) b.setAttribute('type', 'button');
            });
        }

        // Make .tool-btn (divs used as buttons) keyboard-accessible and clickable by Enter/Space
        function makeToolDivsAccessible() {
            document.querySelectorAll('.tool-btn').forEach(el => {
                // Only add role/tabindex if not present (non-visual)
                if (!el.hasAttribute('role')) el.setAttribute('role', 'button');
                if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
                // trigger click on Enter or Space
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        el.click();
                    }
                });
            });
        }

        // Rebind inline onclick attributes into addEventListener (safely)
        function rebindInlineOnclicks() {
            document.querySelectorAll('[onclick]').forEach(el => {
                try {
                    const code = el.getAttribute('onclick');
                    if (!code) return;
                    // remove inline handler to avoid double-call
                    el.removeAttribute('onclick');
                    const fn = new Function('event', code);
                    el.addEventListener('click', function (evt) {
                        try {
                            fn.call(this, evt);
                        } catch (err) {
                            console.error('[mural-fix] inline onclick error', err);
                        }
                    });
                } catch (e) {
                    console.error('[mural-fix] failed rebind onclick', e);
                }
            });
        }

        // ---------- Firebase init ----------
        const firebaseConfig = {
            apiKey: "AIzaSyBeXCRIeRdHr2C3EYnDwC1NoQNQxZygA0U",
            authDomain: "guestbook-bfbdc.firebaseapp.com",
            databaseURL: "https://guestbook-bfbdc-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "guestbook-bfbdc",
            storageBucket: "guestbook-bfbdc.firebasestorage.app",
            messagingSenderId: "710789947600",
            appId: "1:710789947600:web:19014ef99d053f4c5dbed5",
            measurementId: "G-E9XPN9563X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ITEMS = collection(db, 'mural_items');

        const UID = localStorage.getItem('mural_uid') || ('u_' + Math.random().toString(36).slice(2, 9));
        localStorage.setItem('mural_uid', UID);

        // ---------- UI refs (safe to query now because this module is placed at end of body) ----------
        const intro = document.getElementById('intro');
        const loadingSteps = document.getElementById('loadingSteps');
        const sureBtn = document.getElementById('sureBtn');
        const blinker = document.getElementById('blinker');

        const btnDoodle = document.getElementById('btnDoodle');
        const btnNote = document.getElementById('btnNote');
        const btnAdmin = document.getElementById('btnAdmin');

        const doodleModal = document.getElementById('doodleModal');
        const doodleClose = document.getElementById('doodleClose');
        const submitDoodle = document.getElementById('submitDoodle');
        const cancelDoodle = document.getElementById('cancelDoodle');
        const toolBrush = document.getElementById('toolBrush');
        const toolEraser = document.getElementById('toolEraser');
        const toolStampWindow = document.getElementById('toolStampWindow');
        const toolUndo = document.getElementById('toolUndo');
        const toolClear = document.getElementById('toolClear');
        const brushSize = document.getElementById('brushSize');
        const colorPicker = document.getElementById('colorPicker');

        const stampModal = document.getElementById('stampModal');
        const stampGrid = document.getElementById('stampGrid');
        const stampClose = document.getElementById('stampClose');

        const noteModal = document.getElementById('noteModal');
        const submitNote = document.getElementById('submitNote');
        const cancelNote = document.getElementById('cancelNote');
        const noteName = document.getElementById('noteName');
        const noteText = document.getElementById('noteText');

        const muralCanvas = document.getElementById('muralCanvas');
        const sidePanel = document.getElementById('sidePanel');
        const sideClose = document.getElementById('sideClose');
        const sideContent = document.getElementById('sideContent');
        const sideTitle = document.getElementById('sideTitle');
        const adminControls = document.getElementById('adminControls');
        const deleteItem = document.getElementById('deleteItem');
        const clearMural = document.getElementById('clearMural');

        let currentSelectedId = null;
        let fabricCanvas = null;

        // simple pixel stamps (monochrome SVGs)
        const STAMPS = [
            // pixel cat
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><g fill="#000"><rect x="12" y="28" width="40" height="24"/><rect x="8" y="20" width="12" height="12"/><rect x="44" y="20" width="12" height="12"/><rect x="20" y="34" width="6" height="6"/><rect x="38" y="34" width="6" height="6"/></g></svg>'),
            // heart
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><path d="M32 54s-18-12-18-24c0-6 4-10 10-10 4 0 8 3 8 3s4-3 8-3c6 0 10 4 10 10 0 12-18 24-18 24z" fill="#000"/></svg>'),
            // smile
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><circle cx="32" cy="28" r="8" fill="#000"/><rect x="22" y="36" width="20" height="6" fill="#000"/></svg>'),
            // star
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><polygon points="32,12 36,28 52,28 38,36 42,52 32,42 22,52 26,36 12,28 28,28" fill="#000"/></svg>'),
            // floppy
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><rect x="12" y="12" width="40" height="40" fill="#000"/><rect x="18" y="18" width="28" height="18" fill="#fff"/></svg>'),
            // lightning
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><polygon points="28,14 40,14 26,34 38,34 20,54 28,34 18,34" fill="#000"/></svg>'),
            // flower
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><circle cx="32" cy="24" r="6" fill="#000"/><rect x="30" y="30" width="4" height="18" fill="#000"/><circle cx="18" cy="24" r="6" fill="#000"/><circle cx="46" cy="24" r="6" fill="#000"/></svg>'),
            // skull
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><rect x="18" y="18" width="28" height="26" fill="#000"/><rect x="24" y="28" width="6" height="6" fill="#fff"/><rect x="36" y="28" width="6" height="6" fill="#fff"/></svg>'),
            // speech bubble
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><rect x="10" y="12" width="44" height="30" rx="4" fill="#000"/><polygon points="20,42 28,36 22,34" fill="#000"/></svg>'),
            // arrow
            'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#fff"/><polygon points="10,32 42,10 42,24 54,24 54,40 42,40 42,54" fill="#000"/></svg>')
        ];

        // stamp placing flag (declared before stamp tiles used)
        let placingStamp = null;

        // create stamp tiles (this runs immediately)
        STAMPS.forEach((s, idx) => {
            const tile = document.createElement('div');
            tile.className = 'stamp-tile';
            const img = new Image();
            img.src = s;
            img.width = 48;
            img.height = 48;
            img.style.imageRendering = 'pixelated';
            tile.appendChild(img);
            stampGrid.appendChild(tile);

            tile.addEventListener('click', () => {
                placingStamp = s;
                stampModal.style.display = 'none';
                // small feedback
                try { document.getElementById('sndClick').play().catch(()=>{}); } catch (e) {}
            });
        });

        // intro loading steps
        for (let i = 0; i < 12; i++) {
            const d = document.createElement('div');
            d.className = 'loading-step';
            loadingSteps.appendChild(d);
        }

        function runIntro() {
            let idx = 0;
            const step = () => {
                if (idx < loadingSteps.children.length) {
                    loadingSteps.children[idx].style.background = '#fff';
                    idx++;
                    setTimeout(step, 80 + Math.random() * 60);
                } else {
                    sureBtn.style.display = 'inline-block';
                    blinker.style.display = 'block';
                    // blink
                    let on = true;
                    const bInt = setInterval(() => {
                        blinker.style.opacity = on ? '1' : '0.1';
                        on = !on;
                    }, 800);
                    // click/tap/press to dismiss
                    const finish = () => {
                        intro.style.display = 'none';
                        clearInterval(bInt);
                    };
                    sureBtn.addEventListener('click', finish, { once: true });
                    document.addEventListener('keydown', finish, { once: true });
                    document.addEventListener('pointerdown', finish, { once: true });
                }
            };
            setTimeout(step, 220);
        }
        runIntro();

        // ---------- Fabric loader and init ----------
        async function ensureFabricInitialized() {
            if (window.fabric && fabricCanvas) return;
            if (!window.fabric) {
                await import('https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.6.0/fabric.min.js');
            }
            if (!fabricCanvas) {
                // initialize
                fabricCanvas = new fabric.Canvas('doodleCanvas', {
                    isDrawingMode: true,
                    backgroundColor: '#fff',
                    preserveObjectStacking: true
                });
                fabricCanvas.freeDrawingBrush.width = parseInt(brushSize.value, 10) || 4;
                fabricCanvas.freeDrawingBrush.color = colorPicker.value || '#000';
                // brush size change
                brushSize.addEventListener('input', () => {
                    fabricCanvas.freeDrawingBrush.width = parseInt(brushSize.value, 10);
                });
                // color change
                colorPicker.addEventListener('input', () => {
                    fabricCanvas.freeDrawingBrush.color = colorPicker.value;
                });
                // tool buttons
                toolBrush.addEventListener('click', () => {
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.freeDrawingBrush.width = parseInt(brushSize.value, 10);
                    fabricCanvas.freeDrawingBrush.color = colorPicker.value;
                });
                toolEraser.addEventListener('click', () => {
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.freeDrawingBrush.width = Math.max(12, parseInt(brushSize.value, 10));
                    fabricCanvas.freeDrawingBrush.color = '#ffffff';
                });
                toolUndo.addEventListener('click', () => {
                    const objs = fabricCanvas.getObjects();
                    if (objs.length) fabricCanvas.remove(objs[objs.length - 1]);
                });
                toolClear.addEventListener('click', () => {
                    if (confirm('Clear drawing?')) fabricCanvas.clear();
                    fabricCanvas.backgroundColor = '#fff';
                    fabricCanvas.renderAll();
                });
                // mouse down for stamp placement
                fabricCanvas.on('mouse:down', function (opt) {
                    if (placingStamp) {
                        const pointer = fabricCanvas.getPointer(opt.e);
                        fabric.Image.fromURL(placingStamp, function (img) {
                            img.set({
                                left: pointer.x,
                                top: pointer.y,
                                originX: 'center',
                                originY: 'center',
                                selectable: true,
                                hasControls: true
                            });
                            img.scaleToWidth(96);
                            fabricCanvas.add(img).setActiveObject(img);
                        });
                        placingStamp = null;
                        try { document.getElementById('sndPlace').play().catch(()=>{}); } catch (e) {}
                    }
                });
            }
        }

        // ---------- UI binding (use ready so bindings attach reliably) ----------
        ready(() => {
            // ensure button types, accessibility and inline onclick rebinding
            normalizeButtonTypes();
            makeToolDivsAccessible();
            rebindInlineOnclicks();

            // toolbar actions
            btnDoodle.addEventListener('click', openDoodle);
            btnNote.addEventListener('click', openNote);
            btnAdmin.addEventListener('click', adminToggle);

            // note modal
            cancelNote.addEventListener('click', () => noteModal.style.display = 'none');
            submitNote.addEventListener('click', async () => {
                const name = (noteName.value || 'anon');
                const text = (noteText.value || '').trim();
                if (!text) return alert('Write a note');
                try {
                    await addDoc(ITEMS, {
                        type: 'note',
                        text,
                        creator: name,
                        timestamp: serverTimestamp(),
                        x: 50,
                        y: 50,
                        reactionCount: 0,
                        comments: []
                    });
                    noteModal.style.display = 'none';
                    noteText.value = '';
                    noteName.value = '';
                } catch (e) {
                    alert('Save failed: ' + (e.message || e));
                }
            });

            // doodle modal controls
            doodleClose.addEventListener('click', () => doodleModal.style.display = 'none');
            cancelDoodle.addEventListener('click', () => doodleModal.style.display = 'none');
            toolStampWindow.addEventListener('click', () => {
                stampModal.style.display = 'flex';
            });
            stampClose.addEventListener('click', () => stampModal.style.display = 'none');

            // ensure stamp modal/backdrop closes when clicking outside window
            stampModal.addEventListener('click', (e) => {
                if (e.target === stampModal) stampModal.style.display = 'none';
            });
            doodleModal.addEventListener('click', (e) => {
                if (e.target === doodleModal) doodleModal.style.display = 'none';
            });

            // side panel
            sideClose.addEventListener('click', () => {
                sidePanel.style.display = 'none';
                currentSelectedId = null;
            });

            // admin controls
            deleteItem.addEventListener('click', async () => {
                if (!currentSelectedId) return alert('No item selected');
                if (!confirm('Delete item?')) return;
                try {
                    await deleteDoc(doc(db, 'mural_items', currentSelectedId));
                    sidePanel.style.display = 'none';
                } catch (e) {
                    alert('Delete failed');
                }
            });
            clearMural.addEventListener('click', async () => {
                if (!confirm('Clear mural?')) return;
                try {
                    const snap = await getDocs(query(ITEMS, orderBy('timestamp', 'desc')));
                    for (const d of snap.docs) await deleteDoc(doc(db, 'mural_items', d.id));
                    alert('Cleared');
                } catch (e) {
                    alert('Clear failed');
                }
            });

            // submitDoodle binding left to openDoodle (so fabric is ready)
        });

        // open doodle modal
        async function openDoodle() {
            await ensureFabricInitialized();
            doodleModal.style.display = 'flex';
            document.querySelector('.scanline').style.opacity = '0.12';
            // ensure canvas sizes and render
            if (fabricCanvas) {
                fabricCanvas.calcOffset();
                fabricCanvas.renderAll();
            }
            // bind submit (use addEventListener to avoid accidental overrides)
            submitDoodle.removeEventListener('click', submitDoodle._handler || (() => {}));
            const handler = async () => {
                fabricCanvas.discardActiveObject();
                fabricCanvas.renderAll();
                const dataUrl = fabricCanvas.toDataURL({
                    format: 'png',
                    multiplier: 1
                });
                const name = prompt('Your name (optional)') || 'anon';
                try {
                    await addDoc(ITEMS, {
                        type: 'doodle',
                        image: dataUrl,
                        creator: name,
                        timestamp: serverTimestamp(),
                        x: 50,
                        y: 50,
                        reactionCount: 0,
                        comments: []
                    });
                    doodleModal.style.display = 'none';
                    fabricCanvas.clear();
                    fabricCanvas.backgroundColor = '#fff';
                    alert('Saved to mural.');
                } catch (e) {
                    alert('Save failed: ' + (e.message || e));
                }
            };
            submitDoodle._handler = handler;
            submitDoodle.addEventListener('click', handler);
        }

        // open note
        function openNote() {
            noteModal.style.display = 'flex';
            document.querySelector('.scanline').style.opacity = '0.12';
        }

        // admin toggle
        function adminToggle() {
            const p = prompt('Admin password:');
            if (p === 'indobingo') {
                localStorage.setItem('mural_admin', '1');
                adminControls.style.display = 'block';
                alert('Admin enabled');
            } else {
                alert('Wrong');
            }
        }

        // Render mural items from Firestore
        function renderItem(id, data) {
            const existing = document.querySelector('[data-id="' + id + '"]');
            const rectParent = muralCanvas.getBoundingClientRect();
            if (existing) {
                // update maybe (currently no update logic)
                return;
            }
            const el = document.createElement('div');
            el.className = 'mural-item';
            el.dataset.id = id;
            el.style.left = ((data.x || 50) / 100) * (rectParent.width - 100) + 'px';
            el.style.top = ((data.y || 50) / 100) * (rectParent.height - 100) + 'px';
            if (data.type === 'doodle') {
                const img = document.createElement('img');
                img.src = data.image;
                el.appendChild(img);
            } else {
                const nb = document.createElement('div');
                nb.className = 'note-box';
                nb.textContent = data.text;
                el.appendChild(nb);
            }
            // badge
            const badge = document.createElement('div');
            badge.style.position = 'absolute';
            badge.style.right = '6px';
            badge.style.top = '6px';
            badge.style.background = '#000';
            badge.style.color = '#fff';
            badge.style.padding = '2px 6px';
            badge.style.border = '2px solid #fff';
            badge.textContent = '❤ ' + (data.reactionCount || 0);
            badge.addEventListener('click', async (e) => {
                e.stopPropagation();
                const reacted = 'r_' + id;
                if (localStorage.getItem(reacted)) return alert('Already reacted');
                localStorage.setItem(reacted, '1');
                try {
                    await updateDoc(doc(db, 'mural_items', id), {
                        reactionCount: (data.reactionCount || 0) + 1
                    });
                } catch (e) {
                    console.warn(e);
                }
            });
            el.appendChild(badge);

            // click to open side panel
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                currentSelectedId = id;
                sideTitle.textContent = data.creator || 'anon';
                sideContent.innerHTML = '';
                if (data.type === 'doodle') {
                    const img = document.createElement('img');
                    img.src = data.image;
                    img.style.maxWidth = '100%';
                    sideContent.appendChild(img);
                } else {
                    const p = document.createElement('div');
                    p.textContent = data.text;
                    sideContent.appendChild(p);
                }
                // comments
                const commWrap = document.createElement('div');
                commWrap.style.marginTop = '8px';
                const commList = document.createElement('div');
                (data.comments || []).forEach(c => {
                    const cc = document.createElement('div');
                    cc.textContent = (c.name || 'anon') + ': ' + c.text;
                    commList.appendChild(cc);
                });
                commWrap.appendChild(commList);
                const nameIn = document.createElement('input');
                nameIn.placeholder = 'Your name';
                nameIn.style.width = '100%';
                const comIn = document.createElement('input');
                comIn.placeholder = 'Add comment';
                comIn.style.width = '100%';
                const send = document.createElement('button');
                send.textContent = 'Comment';
                send.className = 'tool-small';
                send.type = 'button';
                send.addEventListener('click', async () => {
                    const nm = nameIn.value || 'anon';
                    const txt = comIn.value || '';
                    if (!txt) return;
                    try {
                        await updateDoc(doc(db, 'mural_items', id), {
                            comments: (data.comments || []).concat([{
                                name: nm,
                                text: txt
                            }])
                        });
                        nameIn.value = '';
                        comIn.value = '';
                    } catch (e) {
                        alert('Comment failed');
                    }
                });
                commWrap.appendChild(nameIn);
                commWrap.appendChild(comIn);
                commWrap.appendChild(send);
                sideContent.appendChild(commWrap);
                adminControls.style.display = localStorage.getItem('mural_admin') === '1' ? 'block' : 'none';
                sidePanel.style.display = 'block';
            });

            muralCanvas.appendChild(el);

            // simple drag (pointer)
            let dragging = false,
                startX = 0,
                startY = 0;
            el.addEventListener('pointerdown', (ev) => {
                dragging = true;
                startX = ev.clientX;
                startY = ev.clientY;
                try { el.setPointerCapture(ev.pointerId); } catch (e) {}
                el.style.cursor = 'grabbing';
            });
            window.addEventListener('pointermove', (ev) => {
                if (!dragging) return;
                const dx = ev.clientX - startX,
                    dy = ev.clientY - startY;
                startX = ev.clientX;
                startY = ev.clientY;
                el.style.left = (el.offsetLeft + dx) + 'px';
                el.style.top = (el.offsetTop + dy) + 'px';
            });
            el.addEventListener('pointerup', async () => {
                if (!dragging) return;
                dragging = false;
                el.style.cursor = 'grab';
                const rect = muralCanvas.getBoundingClientRect();
                const px = (el.offsetLeft / rect.width) * 100;
                const py = (el.offsetTop / rect.height) * 100;
                try {
                    await updateDoc(doc(db, 'mural_items', id), {
                        x: px,
                        y: py
                    });
                } catch (e) {
                    console.warn(e);
                }
            });
        }

        // subscribe to Firestore
        const q = query(ITEMS, orderBy('timestamp', 'desc'));
        onSnapshot(q, snap => {
            snap.forEach(d => {
                const id = d.id;
                const data = d.data();
                if (!document.querySelector('[data-id="' + id + '"]')) renderItem(id, data);
            });
        });

        // allow pressing Esc to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                doodleModal.style.display = 'none';
                stampModal.style.display = 'none';
                noteModal.style.display = 'none';
                sidePanel.style.display = 'none';
                document.querySelector('.scanline').style.opacity = '0.06';
            }
        });

    </script>
</body>

</html>
